# TRANSITIONS

# IMPORTANT

* Any behavior not described in this document is undefined behavior
* Transitions are important points in the life cycles of the primitives mentioned in [PRIMITIVES.md](PRIMITIVES.md)
* They represent the core behaviors of the application and, as such, should be targeted for observation and monitoring
* All fields referenced in transitions must exist in PRIMITIVES.md - that document is the source of truth

## Implementation Status

**Currently Implementing:**
- ConversationStarted
- ConversationCheckpointCreated
- MessageAdded

**Future Work:**
- TaskCreated
- TaskCheckpointCreated

# Event Terminology

**Transition Events** (also called "Facts") are emitted after a transition successfully completes. They represent things that have happened in the system.

* Naming: `project_manager.<entity>.<past-tense-action>`
* Example: `project_manager.conversation.started`

# Transitions

### **Transition: `ConversationStarted`**

#### **Description:**

* The initiation of a conversation.

#### **Trigger:**

* External ingress microservice processes a new conversation source (e.g., GitHub project item).
* The `conversation_id` is generated by the system (enables idempotency).

#### **Preconditions:**

* No existing conversation with the same `conversation_id`.

#### **State Changes:**

* A new `Conversation` entity is created with `id`, `actor_ids`, `title`, `external_id`, `external_source`, `created_at`, and `updated_at`.
* Optionally includes `status` and `organization`.

#### **Fact Emitted**

* `project_manager.conversation.started`
  * id
  * actor_ids
  * title
  * external_id (optional)
  * external_source (optional)
  * status (optional)
  * organization (optional)
  * created_at
  * updated_at

#### **Invariants:**

* A conversation is created at most once per `conversation_id`.

* Conversation creation does not imply understanding or acceptance.

* No decision facts exist prior to a checkpoint.

### **Transition: `ConversationCheckpointCreated`**

#### **Description**

An authoritative decision is recorded for a conversation, representing a stable point of understanding or intent. A new checkpoint is created each time the LLM processes the conversation.

#### **Trigger**

* The LLM interface service evaluates conversation context and determines a decisional boundary has been reached.
* The service creates a checkpoint with a summary of the current conversation state.

#### **Preconditions**

* A conversation with the given `conversation_id` exists.
* Sufficient information exists to assert one of the supported checkpoint types.

#### **Checkpoint Types**

* `CONVERSATION_STARTED` — Initial checkpoint when conversation begins.
* `BEGIN_WORK` — Understanding is sufficient and work may be initiated.
* `NEED_INFORMATION` — Progress requires additional input.
* `CLOSE_CONVERSATION` — No further work will occur.
* `WORK_COMPLETED` — All work for this conversation has been completed.

#### **State Changes**

* A new `ConversationCheckpoint` entity is created with `id`, `conversation_id`, `checkpoint_type`, `summary`, and `created_at`.
* The checkpoint is linked to the conversation via `conversation_id`.
* The `summary` field contains an LLM-optimized representation of the conversation state (goals, decisions, open questions, current status).

#### **Fact Emitted**

* `project_manager.conversation.checkpoint.created`
  * id
  * conversation_id
  * checkpoint_type
  * summary
  * created_at

#### **Facts NOT Emitted**

* No tasks are created directly by this transition.

* No conversation state is mutated beyond checkpoint creation.

#### **Invariants**

* Conversation checkpoints are immutable once created.

* A conversation may have zero or more checkpoints.

* Checkpoints represent intent or understanding, not execution.

* All tasks must reference a checkpoint.


### **Transition: `TaskCreated`** *(FUTURE WORK)*

#### **Description:**

* The creation of a Task

#### **Trigger:**

* The LLM interface service creates tasks after a `BEGIN_WORK` checkpoint.
* One task is created per task instruction from the LLM.

#### **Preconditions:**

* An existing conversation
* A conversation checkpoint for that conversation with a type of BEGIN_WORK

#### **State Changes:**

* A new `Task` entity is created with `id`, `conversation_id`, `checkpoint_id`, `instructions`, and `created_at`.
* Optionally includes `assigned_to`.

#### **Fact Emitted**

* `project_manager.task.created`
  * id
  * conversation_id
  * checkpoint_id
  * instructions
  * assigned_to (optional)
  * created_at

#### **Invariants:**

* Tasks are immutable once created.
* There may be one or more tasks per checkpoint of a BEGIN_WORK type.
* All tasks must reference a checkpoint.


### **Transition: `TaskCheckpointCreated`** *(FUTURE WORK)*

#### **Description**

A change in progress for the task, recorded as an immutable checkpoint.

#### **Trigger**

The actor - human or AI - records a progress update (via external systems or task execution agents):

* Started work on a task
* Completed work on a task
* Paused work on a task
* Approved or rejected completed work

#### **Preconditions**

* A task with the given `task_id` exists

#### **State Changes**

* A new `TaskCheckpoint` entity is created with `id`, `task_id`, `type`, and `created_at`.

#### **Checkpoint Types**

* `WORK_STARTED` — Work on the task has begun
* `WORK_COMPLETED` — Work on the task has completed
* `WORK_APPROVED` — A human has signified that the work meets the requirements
* `WORK_REJECTED` - A human has rejected the work
* `WORK_PAUSED` — Work has paused

#### **Fact Emitted**

* `project_manager.task.checkpoint.created`
  * id
  * task_id
  * type
  * created_at

#### **Facts NOT Emitted**

* No alterations to any of the transitions that preceded the event

#### **Invariants**

* Task checkpoints are immutable once created.
* Status of conversations will not be changed through the creation of this event.
* Task status is derived from the most recent TaskCheckpoint for that task.

### **Transition: `MessageAdded`**

#### **Description**

A message has been added to the conversation - from either the human or AI actor.

#### **Trigger**

* Human messages: External ingress microservice processes incoming message from user.
* AI messages: LLM interface service processes and responds to conversation.

#### **Preconditions**

* A conversation with the given `conversation_id` exists
* An actor with the given `actor_id` exists

#### **State Changes**

* A new `Message` entity is created with `id`, `time`, `actor_id`, `conversation_id`, and `content`.
* Optionally includes `task_id` if the message is related to a specific task.
* Optionally includes `external_identity` for correlation with external systems.

#### **Fact Emitted**

* `project_manager.message.added`
  * id
  * time
  * actor_id
  * conversation_id
  * task_id (optional)
  * content
  * external_identity (optional)

#### **Facts NOT Emitted**

* No new conversations, tasks, or checkpoints are created by this event

#### **Invariants**

* Messages are immutable once created.
* Messages in and of themselves do not result in change of state for the conversation.
